# Apache VirtualHost Configuration for Axum API
# Domain: axum.synergyinfinity.id
# Backend: Rust Axum on port 8080

<VirtualHost *:80>
    ServerAdmin webmaster@example.com
    ServerName 35ca3ec6.axum.synergyinfinity.id
    ServerAlias axum.synergyinfinity.id
    DocumentRoot "/www/wwwroot/axum.synergyinfinity.id"
    
    ErrorLog "/www/wwwlogs/axum.synergyinfinity.id-error_log"
    CustomLog "/www/wwwlogs/axum.synergyinfinity.id-access_log" combined
    
    # Custom Log Format - Detailed Request Logging
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %D %{X-Forwarded-For}i" detailed
    CustomLog "/www/wwwlogs/axum.synergyinfinity.id-detailed_log" detailed
    
    # Log rejected requests (4xx, 5xx errors)
    CustomLog "/www/wwwlogs/axum.synergyinfinity.id-rejected_log" combined env=!REDIRECT_STATUS
    
    # Log level for debugging (change to 'warn' in production)
    LogLevel info

    # Enable reverse proxy
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Forward all requests to Axum backend on port 8080
    ProxyPass / http://127.0.0.1:8080/
    ProxyPassReverse / http://127.0.0.1:8080/
    
    # Proxy headers for Axum to know the original request
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"
    RequestHeader set X-Real-IP %{REMOTE_ADDR}s
    RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
    
    # Timeout for long-running requests
    ProxyTimeout 300
    
    # WebSocket support (if needed)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*) ws://127.0.0.1:8080/$1 [P,L]
    
    # Disable CSRF protection for API (CORS handled by Axum)
    <IfModule security2_module>
        SecRuleEngine Off
    </IfModule>
    
    # DENY FILES
    <Files ~ (\.user.ini|\.htaccess|\.git|\.env|\.svn|\.project|LICENSE|README.md|Cargo\.toml|Cargo\.lock)$>
        Order allow,deny
        Deny from all
    </Files>
    
    # PATH
    <Directory "/www/wwwroot/axum.synergyinfinity.id">
        SetOutputFilter DEFLATE
        Options FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex index.html index.htm
    </Directory>
</VirtualHost>

<VirtualHost *:443>
    ServerAdmin webmaster@example.com
    ServerName SSL.axum.synergyinfinity.id
    ServerAlias axum.synergyinfinity.id
    DocumentRoot "/www/wwwroot/axum.synergyinfinity.id/"
    
    ErrorLog "/www/wwwlogs/axum.synergyinfinity.id-error_log"
    CustomLog "/www/wwwlogs/axum.synergyinfinity.id-access_log" combined
    
    # Custom Log Format - Detailed Request Logging with SSL info
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %D %{X-Forwarded-For}i SSL:%{SSL_PROTOCOL}x Cipher:%{SSL_CIPHER}x" detailed_ssl
    CustomLog "/www/wwwlogs/axum.synergyinfinity.id-detailed_log" detailed_ssl
    
    # Log rejected requests (4xx, 5xx errors)
    SetEnvIf Request_URI ".*" REQUEST_STATUS=%>s
    CustomLog "/www/wwwlogs/axum.synergyinfinity.id-rejected_log" combined expr=%{REQUEST_STATUS}>=400
    
    # Log CORS-related requests
    SetEnvIf Origin ".*" HAS_ORIGIN
    CustomLog "/www/wwwlogs/axum.synergyinfinity.id-cors_log" combined env=HAS_ORIGIN
    
    # Log level for debugging (change to 'warn' in production)
    LogLevel info
    
    # SSL Configuration
    SSLEngine On
    SSLCertificateFile /www/server/panel/vhost/cert/axum.synergyinfinity.id/fullchain.pem
    SSLCertificateKeyFile /www/server/panel/vhost/cert/axum.synergyinfinity.id/privkey.pem
    SSLCipherSuite EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5:ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL
    SSLProtocol All -SSLv2 -SSLv3 -TLSv1
    SSLHonorCipherOrder On
    
    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Disable CSRF protection for API (CORS handled by Axum)
    <IfModule security2_module>
        SecRuleEngine Off
    </IfModule>
    
    # Enable reverse proxy
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Forward all requests to Axum backend on port 8080
    ProxyPass / http://127.0.0.1:8080/
    ProxyPassReverse / http://127.0.0.1:8080/
    
    # Proxy headers for Axum to know the original request
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    RequestHeader set X-Real-IP %{REMOTE_ADDR}s
    RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
    
    # Timeout for long-running requests
    ProxyTimeout 300
    
    # Allow larger uploads (5MB for file uploads)
    LimitRequestBody 5242880
    
    # WebSocket support (if needed)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*) wss://127.0.0.1:8080/$1 [P,L]
    
    # DENY FILES
    <Files ~ (\.user.ini|\.htaccess|\.git|\.env|\.svn|\.project|LICENSE|README.md|Cargo\.toml|Cargo\.lock)$>
        Order allow,deny
        Deny from all
    </Files>
    
    # PATH
    <Directory "/www/wwwroot/axum.synergyinfinity.id/">
        SetOutputFilter DEFLATE
        Options FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex index.html index.htm
    </Directory>
</VirtualHost>
